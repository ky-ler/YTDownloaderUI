<Page
    x:Class="YTDownloaderUI.Views.Pages.HomePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:YTDownloaderUI.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:utils="clr-namespace:YTDownloaderUI.Utils"
    Title="HomePage"
    d:DesignHeight="450"
    d:DesignWidth="800"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    mc:Ignorable="d"
    DataContext="{Binding RelativeSource={RelativeSource Self}}"
    >

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <utils:StatusToColorConverter x:Key="StatusToColorConverter" />
    </Page.Resources>

    <ui:DynamicScrollViewer>
        <StackPanel Name="HomePanel" Margin="42">
            <TextBlock
                Margin="0"
                FontSize="20"
                FontWeight="Medium"
                Text="Video Links"
            />

            <ui:TextBox
                x:Name="UrlList"
                Margin="0,12,0,0"
                AcceptsReturn="True"
                MinLines="4"
                MaxLines="10"
                TextChanged="UrlList_TextChanged"
                PlaceholderText="Paste links here (separated by newlines, spaces, or commas)..."
            />

            <Grid x:Name="FFmpegWarning" Visibility="Collapsed" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <ui:InfoBar
                    Grid.Column="0"
                    Title="FFmpeg Not Found"
                    Message="Format presets are disabled. Download from ffmpeg.org and place in the tools folder."
                    Severity="Warning"
                    IsOpen="True"
                    IsClosable="False"
                />
                <ui:Button
                    Grid.Column="1"
                    Content="Refresh"
                    VerticalAlignment="Center"
                    Margin="8,0,0,0"
                    Click="RefreshFFmpeg_Click"
                />
            </Grid>


            <!-- Options and Add to Queue -->
            <Grid Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Checkboxes -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <CheckBox x:Name="PlaylistCheckBox" Content="Download Playlist" Margin="0,0,16,0" />
                    <CheckBox x:Name="SubtitlesCheckBox" Content="Download Subtitles" />
                </StackPanel>

                <!-- Preset and Add to Queue button -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Preset:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox x:Name="PresetComboBox" Width="100" SelectedIndex="0" Margin="0,0,12,0">
                        <ComboBoxItem Content="Default" Tag=""/>
                        <ComboBoxItem Content="mp3" Tag="mp3"/>
                        <ComboBoxItem Content="aac" Tag="aac"/>
                        <ComboBoxItem Content="mp4" Tag="mp4"/>
                        <ComboBoxItem Content="mkv" Tag="mkv"/>
                        <ComboBoxItem Content="sleep" Tag="sleep"/>
                    </ComboBox>
                    <ui:Button
                        x:Name="AddToQueueButton"
                        Content="Add to Queue"
                        Click="AddToQueue_Button_Click"
                        IsEnabled="False"
                    />
                </StackPanel>
            </Grid>

            <!-- Duplicate Warning -->
            <Grid x:Name="DuplicateWarningContainer" Visibility="Collapsed" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <ui:InfoBar
                    x:Name="DuplicateWarning"
                    Grid.Column="0"
                    Title="Duplicate Detected"
                    Message="One or more URLs were already in the queue with the same preset."
                    Severity="Warning"
                    IsOpen="True"
                    IsClosable="False"
                />
                <ui:Button
                    Grid.Column="1"
                    Content="✕"
                    VerticalAlignment="Center"
                    Margin="8,0,0,0"
                    Click="DuplicateWarning_Dismiss_Click"
                />
            </Grid>

            <!-- Validation Error -->
            <Grid x:Name="ValidationErrorContainer" Visibility="Collapsed" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <ui:InfoBar
                    x:Name="ValidationError"
                    Grid.Column="0"
                    Title="Invalid URLs"
                    Message="Some URLs were invalid and not added to the queue."
                    Severity="Error"
                    IsOpen="True"
                    IsClosable="False"
                />
                <ui:Button
                    Grid.Column="1"
                    Content="✕"
                    VerticalAlignment="Center"
                    Margin="8,0,0,0"
                    Click="ValidationError_Dismiss_Click"
                />
            </Grid>

            <TextBlock
                Margin="0,24,0,0"
                FontSize="20"
                FontWeight="Medium"
                Text="Queue" 
            />

            <!-- Error Summary -->
            <Grid x:Name="ErrorSummaryContainer" Visibility="Collapsed" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <ui:InfoBar
                    x:Name="ErrorSummary"
                    Grid.Column="0"
                    Title="Download Errors"
                    Message="Some downloads failed. Click Download to retry."
                    Severity="Error"
                    IsOpen="True"
                    IsClosable="False"
                />
                <ui:Button
                    Grid.Column="1"
                    Content="✕"
                    VerticalAlignment="Center"
                    Margin="8,0,0,0"
                    Click="ErrorSummary_Dismiss_Click"
                />
            </Grid>

            <ItemsControl x:Name="QueueList" Margin="0,12,0,0">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,4,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="60" />
                                <ColumnDefinition Width="60" />
                                <ColumnDefinition Width="90" />
                                <ColumnDefinition Width="60" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Video Title or URL -->
                            <TextBlock
                                Text="{Binding DisplayName}"
                                Grid.Column="0"
                                TextTrimming="CharacterEllipsis"
                                ToolTip="{Binding Url}"
                                VerticalAlignment="Center"
                            />

                            <!-- Options indicators -->
                            <StackPanel
                                Grid.Column="1"
                                Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                ToolTip="{Binding OptionsTooltip}">
                                <TextBlock
                                    Text="P"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource SystemAccentColorPrimaryBrush}"
                                    Visibility="{Binding GetPlaylist, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Margin="0,0,4,0" />
                                <TextBlock
                                    Text="S"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource SystemAccentColorPrimaryBrush}"
                                    Visibility="{Binding GetSubtitles, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- Preset -->
                            <TextBlock
                                Text="{Binding PresetDisplay}"
                                Grid.Column="2"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                            />

                            <!-- Status with color and error indicator -->
                            <StackPanel
                                Grid.Column="3"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Center"
                                >
                                <TextBlock
                                    Text="{Binding Status}"
                                    Foreground="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                />
                                <ui:SymbolIcon
                                    Symbol="ErrorCircle12"
                                    Foreground="Red"
                                    Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    ToolTip="{Binding ErrorMessage}"
                                    Margin="4,0,0,0"
                                    VerticalAlignment="Center"
                                />
                            </StackPanel>

                            <!-- Progress -->
                            <TextBlock
                                x:Name="DlProgress"
                                Text="{Binding DownloadProgress, StringFormat=p1}"
                                Grid.Column="4"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Center"
                            />

                            <!-- Delete Button -->
                            <ui:Button
                                Grid.Column="5"
                                Content="✕"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center"
                                ToolTip="Remove from queue"
                                Click="DeleteQueueItem_Click"
                                Tag="{Binding}"
                            />

                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                <ui:Button
                    x:Name="ClearQueueButton"
                    Content="Clear"
                    Click="ClearQueue_Button_Click"
                    IsEnabled="False"
                />
                <ui:Button
                    x:Name="CancelDownloadButton"
                    Margin="12,0,0,0"
                    Content="Cancel"
                    Click="CancelDownload_Button_Click"
                    Visibility="Collapsed"
                />
                <ui:Button
                    x:Name="StartDownloadButton"
                    Margin="12,0,0,0"
                    Content="Download"
                    Click="StartDownload_Button_Click"
                    IsEnabled="False"
                />
            </StackPanel>

            <TextBlock
                x:Name="StatusText"
                Margin="0,12,0,0"
                Text=""
                HorizontalAlignment="Right"
            />

        </StackPanel>
    </ui:DynamicScrollViewer>
</Page>
